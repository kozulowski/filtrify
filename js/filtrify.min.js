/**
 * jQuery Filtrify v0.2
 * Beautiful advanced tag filtering with HTML5 and jQuery
 * http://luis-almeida.github.com/filtrify
 *
 * Licensed under the MIT license.
 * Copyright 2012 Lu√≠s Almeida
 * https://github.com/luis-almeida
 */

(function(e,t,n,r){function s(t,n,r){this.options=e.extend({},i,r);this._container=e("#"+t);this._holder=e("#"+n);this._items=this._container.children();this._matrix=[];this._fields={};this._order=[];this._menu={};this._query={};this._match=[];this._mismatch=[];this._z=9999;this._any=false;this._bind=function(e,t){return function(){return e.apply(t,arguments)}};this.init()}var i={noresults:"No results match",hide:true,block:[],close:false,query:r,callback:r};s.prototype.init=function(){this.load();this.set();if(this.options.query!==r){this.trigger(this.options.query)}};s.prototype.load=function(){var t,n,i,s,o,u,a;this._items.each(this._bind(function(f,l){t=l.attributes;u={};for(n=0;n<t.length;n++){i=t[n].name;if(i.indexOf("data-")===0&&e.inArray(i,this.options.block)===-1){s=i.replace(/data-/gi,"").replace(/-/gi," ");o=l.getAttribute(i).split(", ");u[s]=o;if(this._fields[s]===r){this._order.push(s);this._fields[s]={}}for(a=0;a<o.length;a++){if(o[a].length){o[a]=o[a].replace(/\\/g,"");this._fields[s][o[a]]=this._fields[s][o[a]]===r?1:this._fields[s][o[a]]+1}}}}this._matrix.push(u)},this))};s.prototype.set=function(){var t=0,n,r=e.browser;this._menu.list=e("<ul class='ft-menu' />");for(t;t<this._order.length;t++){n=r.webkit||r.opera?this._order[t]:this._order[this._order.length-t-1];this._menu[n]={};this.build(n);this.cache(n);this.events(n);this.append(n);this.query(n)}this._holder.html(this._menu.list)};s.prototype.build=function(t){var n,r,i,s=[];n="<li class='ft-field'>"+"<span class='ft-label'>"+t+"</span>"+"<div class='ft-panel ft-hidden'>"+"<ul class='ft-selected' style='display:none;'></ul>"+"<fieldset class='ft-search'><input type='text' placeholder='Search' /></fieldset>"+"<ul class='ft-tags'>";for(i in this._fields[t]){s.push(i)}s.sort();for(r=0;r<s.length;r++){i=s[r];n+="<li data-count='"+this._fields[t][i]+"' >"+i+"</li>"}n+="</ul><div class='ft-mismatch ft-hidden'></div></div></li>";this._menu[t].item=e(n)};s.prototype.cache=function(t){this._menu[t].label=this._menu[t].item.find("span.ft-label");this._menu[t].panel=this._menu[t].item.find("div.ft-panel");this._menu[t].selected=this._menu[t].item.find("ul.ft-selected");this._menu[t].search=this._menu[t].item.find("fieldset.ft-search");this._menu[t].tags=this._menu[t].item.find("ul.ft-tags");this._menu[t].mismatch=this._menu[t].item.find("div.ft-mismatch");this._menu[t].highlight=e([]);this._menu[t].active=e([])};s.prototype.append=function(e){this._menu.list.append(this._menu[e].item)};s.prototype.query=function(e){this._query[e]=[]};s.prototype.events=function(t){e(n).on("click",this._bind(function(){this.closePanel(t)},this));this._menu[t].panel.on("click",this._bind(function(e){e.stopPropagation()},this));this._menu[t].panel.on("mouseenter",this._bind(function(){this.bringToFront(t)},this));this._menu[t].label.on("click",this._bind(function(e){this.openPanel(t);this.bringToFront(t);e.stopPropagation()},this));this._menu[t].search.on("keyup","input",this._bind(function(e){if(e.which===38||e.which===40){return false}else if(e.which===13){if(this._menu[t].highlight.length){this.select(t);this.filter()}}else{this.search(t,e.target.value)}},this));this._menu[t].search.on("keydown","input",this._bind(function(e){if(e.which===40){this.moveHighlight(t,"down");e.preventDefault()}else if(e.which===38){this.moveHighlight(t,"up");e.preventDefault()}},this));this._menu[t].tags.on("mouseenter","li",this._bind(function(n){this.highlight(t,e(n.target))},this));this._menu[t].tags.on("mouseleave","li",this._bind(function(){this.clearHighlight(t)},this));this._menu[t].tags.on("click","li",this._bind(function(){this.select(t);this.filter()},this));this._menu[t].selected.on("click","li",this._bind(function(n){this.unselect(t,e(n.target).text());this.filter()},this))};s.prototype.bringToFront=function(e){this._z=this._z+1;this._menu[e].panel.css("z-index",this._z);this._menu[e].search.find("input").focus()};s.prototype.openPanel=function(e){this._menu[e].label.toggleClass("ft-opened");this._menu[e].panel.toggleClass("ft-hidden");this._menu[e].search.find("input").focus()};s.prototype.closePanel=function(e){this.resetSearch(e);this._menu[e].panel.addClass("ft-hidden");this._menu[e].label.removeClass("ft-opened")};s.prototype.preventOverflow=function(e){var t,n,r,i,s;r=parseInt(this._menu[e].tags.css("maxHeight"),10);s=this._menu[e].tags.scrollTop();i=r+s;n=this._menu[e].highlight.position().top+this._menu[e].tags.scrollTop();t=n+this._menu[e].highlight.outerHeight();if(t>=i){return this._menu[e].tags.scrollTop(t-r>0?t-r:0)}else if(n<s){return this._menu[e].tags.scrollTop(n)}};s.prototype.moveHighlight=function(e,t){if(this._menu[e].highlight.length){var n=t==="down"?"nextAll":"prevAll",r=this._menu[e].highlight[n](":visible:first");if(r.length){this.clearHighlight(e);this.highlight(e,r);this.preventOverflow(e)}}else{this.highlight(e,this._menu[e].tags.children(":visible:first"));this.preventOverflow(e)}};s.prototype.highlight=function(e,t){this._menu[e].highlight=t;this._menu[e].highlight.addClass("ft-highlight")};s.prototype.removeHighlight=function(e){this._menu[e].highlight.removeClass("ft-highlight")};s.prototype.hideHighlight=function(e){this._menu[e].highlight.addClass("ft-hidden")};s.prototype.resetHighlight=function(t){this._menu[t].highlight=e([])};s.prototype.clearHighlight=function(e){this.removeHighlight(e);this.resetHighlight(e)};s.prototype.showMismatch=function(e,t){this._menu[e].mismatch.html(this.options.noresults+' "<b>'+t+'</b>"').removeClass("ft-hidden")};s.prototype.hideMismatch=function(e){this._menu[e].mismatch.addClass("ft-hidden")};s.prototype.search=function(e,t){this.clearHighlight(e);this.showResults(e,t);this.highlight(e,this._menu[e].tags.children(":visible:first"))};s.prototype.resetSearch=function(e){this._menu[e].search.find("input").val("");this._menu[e].tags.children().not(this._menu[e].active).removeClass("ft-hidden");this.hideMismatch(e)};s.prototype.showResults=function(t,n){var r=0;this.hideMismatch(t);this._menu[t].tags.children().not(this._menu[t].active).each(function(){if((this.textContent||this.innerText).toUpperCase().indexOf(n.toUpperCase())>=0){e(this).removeClass("ft-hidden");r=r+1}else{e(this).addClass("ft-hidden")}});if(!r){this.showMismatch(t,n)}};s.prototype.select=function(e){this.updateQueryTags(e,this._menu[e].highlight.text());this.updateActiveClass(e);this.removeHighlight(e);this.appendToSelected(e);this.addToActive(e);this.hideHighlight(e);this.resetHighlight(e);this.resetSearch(e);if(this.options.close){this.closePanel(e)}};s.prototype.updateQueryTags=function(t,n){var r=e.inArray(n,this._query[t]);if(r===-1){this._query[t].push(n)}else{this._query[t].splice(r,1)}};s.prototype.updateActiveClass=function(e){if(this._query[e].length){this._menu[e].label.addClass("ft-active")}else{this._menu[e].label.removeClass("ft-active")}};s.prototype.appendToSelected=function(e){this._menu[e].selected.append(this._menu[e].highlight.clone());this.slideSelected(e)};s.prototype.addToActive=function(e){this._menu[e].active=this._menu[e].active.add(this._menu[e].highlight)};s.prototype.unselect=function(e,t){this.updateQueryTags(e,t);this.removeFromSelected(e,t);this.removeFromActive(e,t);this.updateActiveClass(e);this.resetSearch(e)};s.prototype.removeFromSelected=function(e,t){this._menu[e].selected.children().filter(function(){return(this.textContent||this.innerText)===t}).remove();this.slideSelected(e)};s.prototype.removeFromActive=function(e,t){this._menu[e].active=this._menu[e].active.filter(function(){return(this.textContent||this.innerText)!==t})};s.prototype.slideSelected=function(e){if(this._menu[e].selected.children().length){this._menu[e].selected.slideDown("fast")}else{this._menu[e].selected.slideUp("fast")}};s.prototype.filter=function(){var t,n,r,i,s;this.resetCachedMatch();for(n=this._matrix.length-1;n>=0;n--){s=true;for(t in this._query){i=0;for(r=this._query[t].length-1;r>=0;r--){if(e.inArray(this._query[t][r],this._matrix[n][t])!==-1){i=i+1}}if(!this._query[t].length||(!this._any?i>=this._query[t].length:i>0)){}else{s=false}}this.updateFields(n,s);this.cacheMatch(n,s);this.showMatch(n,s)}this.rewriteFields();this.callback()};s.prototype.updateFields=function(e,t){var n,i,s;for(n in this._fields){if(e===this._matrix.length-1){this._fields[n]={}}i=this._matrix[e][n];if(t&&i){for(s=0;s<i.length;s++){if(i[s].length){this._fields[n][i[s]]=this._fields[n][i[s]]===r?1:this._fields[n][i[s]]+1}}}}};s.prototype.rewriteFields=function(){var e;for(e in this._fields){this._menu[e].tags.children().each(this._bind(function(t,n){var i=n.textContent||n.innerText,s=this._fields[e][i]===r?0:this._fields[e][i];n.setAttribute("data-count",s)},this))}};s.prototype.resetCachedMatch=function(){this._match=[];this._mismatch=[]};s.prototype.cacheMatch=function(e,t){if(t){this._match.unshift(this._items[e])}else{this._mismatch.unshift(this._items[e])}};s.prototype.showMatch=function(e,t){if(this.options.hide){var n=this._items[e].className.indexOf("ft-hidden")!==-1;if(t){if(n)this._items[e].className=this._items[e].className.replace(/ft-hidden/g,"")}else{if(!n)this._items[e].className=this._items[e].className+" ft-hidden"}}};s.prototype.callback=function(){if(this.options.callback!==r&&e.isFunction(this.options.callback)){this.options.callback(this._query,this._match,this._mismatch)}};s.prototype.trigger=function(e,t){var n;this._any=t||false;for(n in this._fields){this.clearSearch(n);this.updateQueryField(n,e);this.updateActiveClass(n);this.updatePanel(n);this.toggleSelected(n)}this.filter()};s.prototype.clearSearch=function(e){this.clearHighlight(e);this.resetSearch(e);this.clearSelected(e)};s.prototype.clearSelected=function(t){this._menu[t].selected.empty();this._menu[t].active=e([])};s.prototype.updateQueryField=function(e,t){this._query[e]=t[e]!==r?t[e]:[]};s.prototype.updatePanel=function(e){var t=0,n,r=this._menu[e].tags.children().removeClass("ft-hidden");for(t;t<this._query[e].length;t++){n=r.filter(this._bind(function(n){return(r[n].textContent||r[n].innerText)===this._query[e][t]},this));this._menu[e].selected.append(n.clone());this._menu[e].active=this._menu[e].active.add(n);n.addClass("ft-hidden")}};s.prototype.toggleSelected=function(e){if(this._menu[e].selected.children().length){this._menu[e].selected.show()}else{this._menu[e].selected.hide()}};s.prototype.reset=function(){this.trigger({})};e.filtrify=function(e,t,n){return new s(e,t,n)}})(jQuery,window,document)